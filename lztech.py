import streamlit as st
import datetime
import json
import os
import pandas as pd
import hashlib
import matplotlib.pyplot as plt # Importar matplotlib para o gr√°fico de histograma

# --- Fun√ß√µes de Utilit√°rio ---

def hash_password(password):
    """Criptografa a senha usando SHA256."""
    return hashlib.sha256(password.encode()).hexdigest()

# --- Configura√ß√£o do Diret√≥rio de Dados ---

# Onde os arquivos JSON dos usu√°rios ser√£o armazenados.
# Para deploy na nuvem (ex: Streamlit Community Cloud), considere
# usar um banco de dados persistente (ex: Firestore, PostgreSQL)
# ou ajustar permiss√µes de escrita se o ambiente for restrito.
DATA_DIR = "dados_usuarios"
os.makedirs(DATA_DIR, exist_ok=True) # Cria o diret√≥rio se n√£o existir

# --- Fun√ß√µes de Manipula√ß√£o de Dados do Usu√°rio ---

def carregar_dados(username):
    """
    Carrega os dados de um usu√°rio de um arquivo JSON.
    Inicializa um dicion√°rio padr√£o se o arquivo n√£o existir ou estiver corrompido.
    Realiza a migra√ß√£o de formatos de dados antigos (apenas n√∫meros) para o novo formato
    (dicion√°rios com valor, tipo_atividade e data).
    """
    user_file = os.path.join(DATA_DIR, f"{username}.json")
    if os.path.exists(user_file):
        try:
            with open(user_file, "r", encoding="utf-8") as f:
                dados = json.load(f)
                # Garante que 'valores' √© uma lista e cont√©m os campos esperados
                if "valores" not in dados or not isinstance(dados["valores"], list):
                    dados["valores"] = [] # Inicializa se ausente ou tipo incorreto

                novos_valores = []
                for item in dados["valores"]:
                    if isinstance(item, (int, float)):
                        # Migra formato antigo (apenas n√∫mero) para o novo formato
                        novos_valores.append({
                            "valor": item,
                            "tipo_atividade": "N√£o especificado",
                            "data": "Desconhecida" # Usar string para datas antigas
                        })
                    elif isinstance(item, dict):
                        # Garante que todos os campos necess√°rios est√£o presentes no dicion√°rio
                        # e adiciona padr√µes se estiverem faltando
                        novos_valores.append({
                            "valor": item.get("valor", 0.0),
                            "tipo_atividade": item.get("tipo_atividade", "N√£o especificado"),
                            "data": item.get("data", "Desconhecida")
                        })
                    else:
                        st.warning(f"Tipo de dado inesperado encontrado para '{username}': {type(item)}. Ignorando entrada.")
                dados["valores"] = novos_valores
                return dados
        except json.JSONDecodeError:
            st.error(f"Erro ao ler o arquivo de dados para '{username}'. Criando um novo arquivo de dados.")
            return {"senha": "", "valores": []}
    else:
        return {"senha": "", "valores": []}

def salvar_dados(username, dados):
    """Salva os dados do usu√°rio em um arquivo JSON."""
    user_file = os.path.join(DATA_DIR, f"{username}.json")
    try:
        with open(user_file, "w", encoding="utf-8") as f:
            json.dump(dados, f, indent=4) # Adiciona indenta√ß√£o para legibilidade
    except IOError as e:
        st.error(f"Erro ao salvar dados para '{username}': {e}")

# --- Configura√ß√£o da P√°gina Streamlit ---

st.set_page_config(page_title="LZTech Chatbot", layout="centered")
st.markdown(f"# ü§ñ Bem-vindo ao LZTech\nüìÖ Data: {datetime.datetime.now().strftime('%d/%m/%Y')}")

# --- Se√ß√£o de Autentica√ß√£o na Barra Lateral ---

st.sidebar.header("üîê Login ou Cadastro")
username_input = st.sidebar.text_input("Usu√°rio", key="username_auth")
password_input = st.sidebar.text_input("Senha", type="password", key="password_auth")
action_auth = st.sidebar.radio("A√ß√£o", ["Login", "Cadastrar"], key="action_auth")

# --- L√≥gica de Autentica√ß√£o e A√ß√µes P√≥s-Login ---

# Vari√°vel de estado para controlar se o usu√°rio est√° logado
if "logged_in" not in st.session_state:
    st.session_state.logged_in = False
if "current_username" not in st.session_state:
    st.session_state.current_username = ""

if username_input and password_input:
    dados_usuario = carregar_dados(username_input)
    senha_hash_input = hash_password(password_input)

    if action_auth == "Cadastrar":
        if os.path.exists(os.path.join(DATA_DIR, f"{username_input}.json")) and dados_usuario["senha"] != "":
            st.sidebar.warning("Usu√°rio j√° existe. Por favor, escolha outro nome de usu√°rio ou fa√ßa login.")
        else:
            dados_usuario["senha"] = senha_hash_input
            salvar_dados(username_input, dados_usuario)
            st.sidebar.success("Cadastro realizado com sucesso! Agora fa√ßa login.")
            st.info("Usu√°rio cadastrado com sucesso. Por favor, use suas credenciais para fazer login.")
            # Limpar campos para evitar login autom√°tico ap√≥s cadastro
            st.session_state.logged_in = False
            st.session_state.current_username = ""
    elif action_auth == "Login":
        if dados_usuario["senha"] == senha_hash_input and dados_usuario["senha"] != "":
            st.session_state.logged_in = True
            st.session_state.current_username = username_input
            st.sidebar.success(f"Login bem-sucedido! Bem-vindo(a), {username_input}!")
        else:
            st.sidebar.error("Usu√°rio ou senha incorretos, ou usu√°rio n√£o cadastrado.")
            st.session_state.logged_in = False
            st.session_state.current_username = ""
else:
    if not st.session_state.logged_in:
        st.sidebar.info("Digite seu usu√°rio e senha para fazer login ou cadastrar-se.")

# --- Conte√∫do Principal Ap√≥s o Login ---

if st.session_state.logged_in:
    st.markdown(f"## Ol√°, {st.session_state.current_username}!")
    st.markdown("### A√ß√µes dispon√≠veis:")
    st.markdown("- ‚ûï **Adicionar valor**\n- üìä **Ver todos os dados**\n- ‚ûó **Ver a soma total**\n- üìà **Gr√°fico de valores**\n- üßπ **Limpar dados**\n- üì• **Exportar CSV**")

    # Recarregar dados do usu√°rio logado
    current_user_data = carregar_dados(st.session_state.current_username)

    acao = st.selectbox("Escolha uma a√ß√£o:",
                        ["Adicionar valor", "Ver todos os dados", "Ver a soma total",
                         "Gr√°fico de valores", "Limpar dados", "Exportar CSV"],
                        key="main_action_select")

    if acao == "Adicionar valor":
        st.markdown("---")
        st.write("### Adicionar Novo Valor")
        with st.form("adicionar_valor_form"):
            valor = st.number_input("Digite um valor num√©rico:", step=0.01, format="%.2f")
            tipo_atividade = st.text_input("Tipo de atividade (ex: Compras, Sal√°rio, Lazer):")
            data_atividade = st.date_input("Data da atividade:", datetime.date.today())

            submitted = st.form_submit_button("Adicionar Valor")
            if submitted:
                if valor is not None:
                    # Adiciona um dicion√°rio com valor, tipo de atividade e data
                    current_user_data["valores"].append({
                        "valor": valor,
                        "tipo_atividade": tipo_atividade if tipo_atividade else "N√£o especificado", # Garante um valor padr√£o
                        "data": data_atividade.strftime("%Y-%m-%d") # Formata a data para string padr√£o
                    })
                    salvar_dados(st.session_state.current_username, current_user_data)
                    st.success(f"Valor **{valor:.2f}** (Tipo: **{tipo_atividade if tipo_atividade else 'N√£o especificado'}**) em **{data_atividade.strftime('%d/%m/%Y')}** adicionado com sucesso!")
                else:
                    st.error("Por favor, digite um valor num√©rico.")

    elif acao == "Ver todos os dados":
        st.markdown("---")
        st.write("### üìã Valores Armazenados:")
        if current_user_data["valores"]:
            # Cria um DataFrame a partir da lista de dicion√°rios
            df_valores = pd.DataFrame(current_user_data["valores"])
            # Reorganiza as colunas para melhor visualiza√ß√£o
            df_valores = df_valores[["data", "tipo_atividade", "valor"]]
            st.dataframe(df_valores, use_container_width=True)
        else:
            st.info("Nenhum valor armazenado ainda. Adicione alguns valores!")

    elif acao == "Ver a soma total":
        st.markdown("---")
        # Calcula a soma apenas dos valores num√©ricos
        total = sum([item["valor"] for item in current_user_data["valores"]]) if current_user_data["valores"] else 0
        st.metric("üî¢ Soma total dos dados:", f"R$ {total:.2f}")

    elif acao == "Gr√°fico de valores":
        st.markdown("---")
        if current_user_data["valores"]:
            # Extrai apenas os valores num√©ricos para o gr√°fico de linha
            valores_numericos = [item["valor"] for item in current_user_data["valores"]]
            if valores_numericos: # Verifica se h√° valores ap√≥s a extra√ß√£o
                st.write("### Tend√™ncia dos Valores ao longo do tempo")
                # Cria DataFrame com √≠ndices para simular tempo
                df_grafico = pd.DataFrame(valores_numericos, columns=["Valores"])
                st.line_chart(df_grafico)

                st.markdown("---")
                st.write("### Distribui√ß√£o dos Valores")
                fig, ax = plt.subplots()
                ax.hist(valores_numericos, bins=len(set(valores_numericos)) if len(set(valores_numericos)) < 10 else 10, edgecolor='black') # Ajusta bins
                ax.set_title('Distribui√ß√£o dos Valores')
                ax.set_xlabel('Valor')
                ax.set_ylabel('Frequ√™ncia')
                st.pyplot(fig)
            else:
                st.info("Nenhum dado num√©rico para exibir o gr√°fico.")
        else:
            st.info("Nenhum dado para exibir o gr√°fico. Adicione alguns valores primeiro!")

    elif acao == "Limpar dados":
        st.markdown("---")
        st.warning("Esta a√ß√£o remover√° **TODOS** os seus dados armazenados. Tem certeza?")
        if st.button("Sim, Confirmar limpeza dos dados"):
            current_user_data["valores"] = []
            salvar_dados(st.session_state.current_username, current_user_data)
            st.success("Todos os seus dados foram removidos com sucesso.")

    elif acao == "Exportar CSV":
        st.markdown("---")
        if current_user_data["valores"]:
            # Cria um DataFrame a partir da lista de dicion√°rios para exporta√ß√£o
            df_export = pd.DataFrame(current_user_data["valores"])
            # Garante a ordem das colunas para o CSV
            df_export = df_export[["data", "tipo_atividade", "valor"]]
            csv = df_export.to_csv(index=False).encode('utf-8')
            st.download_button(
                label="üì• Baixar Dados como CSV",
                data=csv,
                file_name=f"{st.session_state.current_username}_valores.csv",
                mime="text/csv"
            )
        else:
            st.info("Nenhum dado para exportar. Adicione alguns valores primeiro!")

    # --- Bot√£o de Logout ---
    st.sidebar.markdown("---")
    if st.sidebar.button("Sair (Logout)", key="logout_button"):
        st.session_state.logged_in = False
        st.session_state.current_username = ""
        st.rerun() # Recarrega a p√°gina para resetar o estado


else:
    # Mensagem se o usu√°rio n√£o estiver logado
    st.markdown("---")
    st.info("Por favor, fa√ßa login ou cadastre-se na barra lateral para acessar as funcionalidades.")

